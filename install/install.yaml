---
apiVersion: v1
kind: Namespace
metadata:
  name: dts
  labels:
    name: dts
    qf-istio-discovery: enabled
    qf-useistio: enabled
---
# Source: dts-api-server/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dboperator
  namespace: dts
---
# Source: dts-api-server/templates/secret.yaml
# Source: Secret.yaml
apiVersion: v1
data:
  password: XXX
  username: XXX
kind: Secret
metadata:
  labels:
    AppName: qfusion-cmdb
    CreatedBy: woqutech.com
    DBBranch: mysql5.7
    DBType: Database
    TenantId: 847798ee3db44716b6357b04e5a55c16
    app.kubernetes.io/instance: qfusion-mysqlcluster
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: qfusion-cmdb
    app.kubernetes.io/version: 0.1.0
    helm.sh/chart: mysqlcluster-0.1.0
    installer.woqutech.com/managed-by: qfusion-installer-operator
    installer.woqutech.com/package: qfusion-mysqlcluster
  name: cmdb0-root-suffix
  namespace: dts
type: Opaque
---
# Source: dts-api-server/templates/configmap.yaml
apiVersion: v1
data:
  timezone: |
    Asia/Shanghai
kind: ConfigMap
metadata:
  name: timezone
  namespace: dts
---
# Source: dts-api-server/templates/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: data
  namespace: dts
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 200Gi
  storageClassName: csi-localpv
  volumeMode: Filesystem
---
# Source: dts-api-server/templates/serviceaccount.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: dts-admin
  annotations:
    rbac.authorization.k8s.io/auroupdate: "true"
  labels:
    kubernets.io/bootstrapping: "rbac-defaults"
rules:
- apiGroups:
    - '*'
  resources:
    - '*'
  verbs:
    - '*'
- nonResourceURLs:
    - '*'
  verbs:
    - '*'
---
# Source: dts-api-server/templates/serviceaccount.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: dboperator-dts
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dts-admin
subjects:
  - kind: ServiceAccount
    name: dboperator
    namespace: dts
---
# Source: dts-api-server/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: dts-api-server
  namespace: dts
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: dts-api-server
  ports:
    - name: http
      port: 3000
      targetPort: 3000
    - name: grpc
      port: 3001
      targetPort: 3001
---
# Source: dts-api-server/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dts-api-server
  namespace: dts
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app.kubernetes.io/name: dts-api-server
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      name: dts-api-server
      labels:
        app.kubernetes.io/name: dts-api-server
        qfusion/useIstio: "true"
    spec:
      serviceAccountName: dboperator
      terminationGracePeriodSeconds: 30
      affinity: 
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                - dts-api-server
            topologyKey: kubernetes.io/hostname
      
      tolerations: 
        - effect: NoExecute
          key: qfusion/master
          operator: Exists
        - effect: NoExecute
          key: node-role.kubernetes.io/master
          operator: Exists
          tolerationSeconds: 60
      containers:
        - name: api
          image: k8smaster.qfusion.irds/irds/dbmotion:2310-hcs-oem
          imagePullPolicy: Always
          securityContext:
            privileged: true
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          env:
            - name: DBMOTION_IMAGE
              value: k8smaster.qfusion.irds/irds/dbmotion:2310-hcs-oem
            - name: DBMOTION_BINLOG_CACHE_ADDR
              value: "PLAINTEXT://0.0.0.0:9092"
            - name: DBMOTION_INIT_IMAGE
              value: k8smaster.qfusion.irds/irds/alpine:3.18.2
            - name: DBMOTION_WEB_ADDR
              value: http://dts-ingressgateway:80
            - name: DBMOTION_PUB_IP
              value: 127.0.0.1
            - name: DBMOTION_GORM_DEBUG
              value: "yes"
            - name: SERVER_MODE
              value: "SAAS"
            - name: K8S_NAMESPACE
              value: "dts"
            - name: NODE_SELECTOR_KEY
              value: "qfusion/node"
            - name: NODE_SELECTOR_VALUE
              value: ""
            - name: MASTER_TOLERATION
              value: "y"
            - name: MYSQL_HOST
              value: qfusion-cmdb0.qfusion
            - name: MYSQL_PORT
              value: "3306"
            - name: DBMOTION_SECURITY_ENABLE
              value: "y"
            - name: MYSQL_USER_NAME
              valueFrom:
                secretKeyRef:
                  key: username
                  name: cmdb0-root-suffix
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: cmdb0-root-suffix
            - name: CPU_REQUEST
              value: 100m
            - name: CPU_LIMIT
              value: "4"
            - name: MEMORY_REQUEST
              value: 100Mi
            - name: MEMORY_LIMIT
              value: 8Gi
            - name: ELASTICSEARCH_URI
              value: http://elasticsearch-logging.dts:9200
            - name: PHOENIX_ENDPOINT
              value: http://phoenix.dts:9091/api/v2/phoenix
            - name: ELASTICSEARCH_IDX
              value: "qfrds-dbmotion.log*"
            - name: SAAS_MODE
              value: "SAAS"
            - name: CMDB_URI
              value: $(MYSQL_USER_NAME):$(MYSQL_PASSWORD)@qfusion-cmdb0.qfusion:3306/webserver
          volumeMounts:
            - name: localtime
              mountPath: /etc/localtime
            - name: log-volume
              mountPath: /dbmotion/log
          ports:
            - name: http
              containerPort: 3000
              protocol: TCP
            - name: grpc
              containerPort: 3001
              protocol: TCP
        - env:
            - name: KAFKA_LISTENERS
              value: PLAINTEXT://0.0.0.0:9092
            - name: KAFKA_ADVERTISED_LISTENERS
              value: PLAINTEXT://:9092
            - name: KAFKA_LOG_DIRS
              value: /kafka/kf
            - name: ZOOKEEPER_DATA__DIR
              value: /kafka/zk
          image: k8smaster.qfusion.irds/irds/kafka:hcs-oem
          imagePullPolicy: Always
          name: kafka
          ports:
            - containerPort: 9092
              protocol: TCP
          resources:
            requests:
              cpu: 100m
              memory: 100Mi
          securityContext:
            capabilities:
              drop:
                - ALL
            runAsNonRoot: true
            runAsUser: 1001
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
            - mountPath: /kafka
              name: data
            - mountPath: /etc/timezone
              name: timezone
              subPath: timezone
            - mountPath: /etc/localtime
              name: localtime
      volumes:
        - name: timezone
          configMap:
            name: timezone
        - name: localtime
          hostPath:
            path: /etc/localtime
        - name: log-volume
          emptyDir: { }
---
# Source: dts-ui/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: web-nginx-conf
  namespace: dts
data:
  nginx.conf: |

    #user nobody;
    worker_processes 1;
    # worker_processes  auto;

    events {
        worker_connections 1024;
    }

    http {
        include mime.types;
        default_type application/octet-stream;
        underscores_in_headers on;

        sendfile on;
        #tcp_nopush on;

        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        keepalive_timeout 70;

        # ...... 413 ......
        client_max_body_size 20m;
        client_body_buffer_size 20m;

        # ............... http ...........................
        # ...... Upgrade ............... close........................ nginx ..................... Connection ...... ''
        map $http_upgrade $connection_upgrade {
            default upgrade;
            '' close;
        }

        server {
            listen 8080;
            # server_name localhost;

            add_header 'Access-Control-Allow-Origin' "$http_origin";
            add_header 'Access-Control-Allow-Credentials' "true";
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE' always;
            add_header 'Access-Control-Allow-Headers' 'project-uid, x-project-id, x-tenant-id, x-real-ip, x-forwarded-ip, accept, content-type, host';

            if ($request_method !~ ^(GET|POST|PUT|DELETE)$) {
                return 405;
            }

            # if ($request_method = 'OPTIONS') {
            #     add_header 'Access-Control-Allow-Origin' '*';
            #     add_header 'Access-Control-Allow-Credentials' 'true';
            #     add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
            #     add_header 'Access-Control-Allow-Headers' 'traceId,channel,callerId,version,type';
            #     add_header 'Access-Control-Max-Age' 1728000;
            #     add_header 'Content-Type' 'text/plain charset=UTF-8';
            #     add_header 'Content-Length' 0;
            #     return 204;
            # }


            location / {
                root /usr/share/nginx/html;
                index index.html;
                try_files $uri /index.html;

                if ($request_filename ~* .*\.(?:htm|html|json|md)$) {
                    add_header Cache-Control "private, no-store, no-cache, must-revalidate, proxy-revalidate";
                }
            }

            location /dts/ {
                alias /usr/share/nginx/html/;
                index index.html;
                try_files $uri /index.html;

                if ($request_filename ~* .*\.(?:htm|html|json|md)$) {
                    add_header Cache-Control "private, no-store, no-cache, must-revalidate, proxy-revalidate";
                }
            }

            location ~* ^/dts/grafana/ {
              root /client_files;
              proxy_pass http://grafana.dts:3000;
              proxy_set_header Authorization "";
              proxy_set_header Host $http_host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection $connection_upgrade;
              proxy_http_version 1.1;
              proxy_connect_timeout 36000;
              proxy_read_timeout 36000;
              proxy_send_timeout 36000;
              send_timeout 36000;
            }

            location ~* ^/api/motion/v2/template_file {
                root /template_files;
                proxy_pass http://dts-api-server.dts:3000;
                proxy_set_header Host $http_host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
                proxy_http_version 1.1;
                proxy_connect_timeout 36000;
                proxy_read_timeout 36000;
                proxy_send_timeout 36000;
                send_timeout 36000;
            }


            location ~* ^/api/motion {
                # rewrite ^/api/v1/(.*)$ /v1/$1 break;
                proxy_pass http://dts-api-server.dts:3000;
                proxy_set_header Host $http_host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
                proxy_http_version 1.1;
                proxy_connect_timeout 36000;
                proxy_read_timeout 36000;
                proxy_send_timeout 36000;
                send_timeout 36000;
            }

            error_page 500 502 503 504 /50x.html;
            location = /50x.html {
                root html;
            }
        }
    }
---
# Source: dts-ui/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: dts-ui
  namespace: dts
spec:
  type: NodePort
  selector:
    app.kubernetes.io/name: dts-ui
  ports:
    - name: http
      port: 8080
      targetPort: 8080
      nodePort: 30001
---
# Source: dts-ui/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dts-ui
  namespace: dts
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: dts-ui
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: dts-ui
        qfusion/useIstio: "true"
    spec:
      affinity: 
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                - dts-ui
            topologyKey: kubernetes.io/hostname
      
      containers:
        - name: ui
          image: k8smaster.qfusion.irds/irds/dbmotion-ui:2310-hcs-oem
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
          volumeMounts:
            - name: localtime
              mountPath: /etc/localtime
            - name: web-nginx-conf
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
      restartPolicy: Always
      terminationGracePeriodSeconds: 0
      volumes:
        - name: localtime
          hostPath:
            path: /usr/share/zoneinfo/Asia/Shanghai
            type: ""
        - name: web-nginx-conf
          configMap:
            name: web-nginx-conf
---
# Source: elasticsearch/templates/serviceaccount.yaml
# RBAC authn and authz
apiVersion: v1
kind: ServiceAccount
metadata:
  name: elasticsearch-logging
  namespace: dts
  labels:
    helm.sh/chart: elasticsearch-0.1.0
    app.kubernetes.io/name: elasticsearch
    app.kubernetes.io/instance: elasticsearch
    app.kubernetes.io/version: "6.8.7"
    app.kubernetes.io/managed-by: Helm
---
# Source: elasticsearch/templates/configmap.yaml
apiVersion: v1
data:
  elasticsearch.yml: |
    cluster:
      name:  ${CLUSTER_NAME:escluster}
    thread_pool:
      write:
        size: 6
    node:
      master: ${NODE_MASTER}    # true of false
      data: ${NODE_DATA}    # true of false
      name: ${NODE_NAME}
      ingest: true
      max_local_storage_nodes: 1
    processors: 5
    network.host: 0.0.0.0
    path:
      data: /usr/share/elasticsearch/data
      logs: /usr/share/elasticsearch/log
    bootstrap:
      memory_lock: false
      system_call_filter: false
    http:
      enabled: true
      compression: true
    discovery:
      zen:
        ping.unicast.hosts: elasticsearch-discovery
        minimum_master_nodes: ${NUMBER_OF_MASTER}
    xpack.ml.enabled: false
kind: ConfigMap
metadata:
  name: elasticsearch
---
# Source: elasticsearch/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: elasticsearch-cleaner-config
data:
  config.yaml: |
    defaultExpire: 30
---
# Source: elasticsearch/templates/serviceaccount.yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: elasticsearch-logging-dts
  labels:
    helm.sh/chart: elasticsearch-0.1.0
    app.kubernetes.io/name: elasticsearch
    app.kubernetes.io/instance: elasticsearch
    app.kubernetes.io/version: "6.8.7"
    app.kubernetes.io/managed-by: Helm
rules:
  - apiGroups:
      - ""
    resources:
      - "services"
      - "namespaces"
      - "endpoints"
    verbs:
      - "get"
---
# Source: elasticsearch/templates/serviceaccount.yaml
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: elasticsearch-logging-dts
  labels:
    helm.sh/chart: elasticsearch-0.1.0
    app.kubernetes.io/name: elasticsearch
    app.kubernetes.io/instance: elasticsearch
    app.kubernetes.io/version: "6.8.7"
    app.kubernetes.io/managed-by: Helm
    k8s-app: elasticsearch-logging
subjects:
- kind: ServiceAccount
  name: elasticsearch-logging
  namespace: dts
  apiGroup: ""
roleRef:
  kind: ClusterRole
  name: elasticsearch-logging-dts
  apiGroup: ""
---
# Source: elasticsearch/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: elasticsearch-discovery
  namespace: dts
  labels:
    helm.sh/chart: elasticsearch-0.1.0
    app.kubernetes.io/name: elasticsearch
    app.kubernetes.io/instance: elasticsearch
    app.kubernetes.io/version: "6.8.7"
    app.kubernetes.io/managed-by: Helm
spec:
  publishNotReadyAddresses: true
  selector:
    app.kubernetes.io/name: elasticsearch
    app.kubernetes.io/instance: elasticsearch
  ports:
    - name: transport
      port: 9300
      protocol: TCP
    - name: db
      port: 9200
      protocol: TCP
  clusterIP: None
---
# Source: elasticsearch/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: 
    elasticsearch-logging
  namespace: dts
  labels:
    helm.sh/chart: elasticsearch-0.1.0
    app.kubernetes.io/name: elasticsearch
    app.kubernetes.io/instance: elasticsearch
    app.kubernetes.io/version: "6.8.7"
    app.kubernetes.io/managed-by: Helm
spec:
  ports:
    - port: 9200
      protocol: TCP
      targetPort: db
  selector:
    app.kubernetes.io/name: elasticsearch
    app.kubernetes.io/instance: elasticsearch
---
# Source: elasticsearch/templates/daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: elasticsearch
  namespace: dts
  labels:
    helm.sh/chart: elasticsearch-0.1.0
    app.kubernetes.io/name: elasticsearch
    app.kubernetes.io/instance: elasticsearch
    app.kubernetes.io/version: "6.8.7"
    app.kubernetes.io/managed-by: Helm
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: elasticsearch
      app.kubernetes.io/instance: elasticsearch
  template:
    metadata:
      labels:
        app.kubernetes.io/name: elasticsearch
        app.kubernetes.io/instance: elasticsearch
    spec:
      nodeSelector: 
        qfusion/master: "true"
      tolerations: 
        - effect: NoSchedule
          key: qfusion/master
          operator: Exists
        - effect: NoSchedule
          key: node-role.kubernetes.io/master
          operator: Exists
      initContainers: # will always initialize before other containers
        - name: init-sysctl
          image: k8smaster.qfusion.irds/irds/alpine:3.18.2
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh","-c"," sysctl -w vm.max_map_count=262144 && chown -R 1000 /usr/share/elasticsearch/data"]
          securityContext:
            privileged: true
          volumeMounts:
            - mountPath: /usr/share/elasticsearch/data
              name: storage
      containers:  # specification of normal containers
        - name: es
          securityContext:
            capabilities:
              add:
                - IPC_LOCK
          image: k8smaster.qfusion.irds/irds/elasticsearch:6.8.18-hcs-oem
          imagePullPolicy: Always
          env:
            - name: "CLUSTER_NAME"
              value: "myescluster"
            - name: "DISCOVERY_SERVICE"
              value: "elasticsearch-discovery"
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: "NODE_MASTER"
              value: "true"
            - name: "NODE_DATA"
              value: "true"
            - name: "NUMBER_OF_MASTER"
              value: "1"
            - name: ES_JAVA_OPTS
              value: -Xms2g -Xmx2g
          ports:
            - containerPort: 9200
              name: db
              protocol: TCP
            - containerPort: 9300
              name: transport
              protocol: TCP
          readinessProbe:
            exec:
              command:
                - sh
                - -c
                - curl --fail 127.0.0.1:9200/_cluster/health
            initialDelaySeconds: 20
            timeoutSeconds: 5
          volumeMounts:
            - mountPath: /usr/share/elasticsearch/data
              name: storage
            - mountPath: /usr/share/elasticsearch/config/elasticsearch.yml
              name: config
              subPath: elasticsearch.yml
      volumes:
        - name: storage
          hostPath:
            path: /opt/dts/elasticsearch 
            type: DirectoryOrCreate
        - configMap:
            defaultMode: 420
            items:
              - key: elasticsearch.yml
                path: elasticsearch.yml
            name: elasticsearch
          name: config
---
# Source: elasticsearch/templates/job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: elasticsearch-config-job-v3.13.11
  namespace: dts
spec:
  template:
    spec:
      nodeSelector: 
            qfusion/master: "true"
      serviceAccountName: elasticsearch-logging
      containers:
        - name: runner
          image: "k8smaster.qfusion.irds/irds/elasticsearch-config-job:v0.3.2-hcs-oem"
          imagePullPolicy: IfNotPresent
          command: [ "/bin/bash",  "/config-es.sh" ]
          env:
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: ES_PORT
              value: "9200"
            - name: SERVICE_NAME
              value: elasticsearch-discovery
            - name: MAX_RESULT_WINDOW
              value: "50000"
      restartPolicy: OnFailure
  backoffLimit: 5
---
# Source: elasticsearch/templates/cronjob.yaml
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: elasticsearch-cleaner
spec:
  schedule: "30 23 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        spec:
          nodeSelector: 
            qfusion/master: "true"
          tolerations: 
            - effect: NoSchedule
              key: qfusion/master
              operator: Exists
            - effect: NoSchedule
              key: node-role.kubernetes.io/master
              operator: Exists
          containers:
          - name: efk-cleaner
            image: k8smaster.qfusion.irds/irds/efk-cleaner:v1.3.7
            imagePullPolicy: IfNotPresent
            volumeMounts:
            - name: config
              mountPath: /etc/config.yaml
              subPath: config.yaml
            - name: localtime
              mountPath: /etc/localtime
          volumes:
          - name: config
            configMap:
              items:
              - key: config.yaml
                path: config.yaml
              name: elasticsearch-cleaner-config
          - name: localtime
            hostPath:
              path: /etc/localtime
          restartPolicy: OnFailure
---
# Source: fluentbit/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
    name: fluent-bit
    namespace: dts
---
# Source: fluentbit/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
    name: fluentbit
    namespace: dts
data:
  filter_cgolib.conf: |-
    [FILTER]
        Name  go
        Match  *
        golib_so /fluent-bit/lib/cgolib.so
        lib_args -logtostderr=true
        # modules that you must init, split by ','
        init_modules k8s
        # for k8s init
        # kube_config /fluent-bit/etc/kube-config   // in cluster , no need config
        # filters in cgolib you want to use. key must begin with 'filters'
        filters_1  parseFilter
        parse_config_file  /fluent-bit/etc/filter_cgolib.yaml
  
    [FILTER]
        name   grep
        match  containerlog
        regex  log .+
  filter_cgolib.yaml: |
    parseConfig:
      match:
        # 不要使用pod的label或者annotation进行匹配
        # 使用路径或者容器名称进行匹配
        matchField:
          - name: alllog
            key: tag
            matchRegex: ".+"
          - name: empdirlog
            key: logpath
            matchRegex: .*empty-dir.*
          - name: containerlog
            key: logpath
            matchRegex: .*log/containers.*
  
      parser:
        parseRegex:
          - name: getPodUid
            key: logpath
            preserve_key: true
            regex: ".*pods/?(?P<podUid>[a-z0-9](?:[-a-z0-9]*[a-z0-9]))?/volumes/.*"
          - name: getPodName
            key: logpath
            preserve_key: true
            regex: '([^.]+)?/(?P<podName>[a-z0-9](?:[-a-z0-9]*[a-z0-9])?(?:\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*)_(?P<podNamespace>[^_]+)_(?P<container>.+)-(?P<dockerId>[a-z0-9]{64})\.log$'
        parseK8sUid:
          - name: getPodInfoByUid
            key: podUid
        parseK8sName:
          - name: getPodInfoByName
            key: podName
            namespaceKey: podNamespace
        parseJson:
          - name: externalLog
            key: log
            preserve_key: false
        parseTimer:
          - name: parseMySQLTime
            key: time
            formats:
            - format: 2006-01-02T15:04:05.000000+08:00
            - offset: 8
              format: 2006-01-02 15:04:05
          - name: parseMySQLAuditTime
            formats:
              - format: 2006-01-02T15:04:05Z
              - format: 2006-01-02T15:04:05 MST
            key: timestamp
          - name: parseTidbAuditTime
            key: time
            formats:
            - format: 2006/01/02 15:04:05.000 +08:00
          - name: parseGaussDBTime
            key: time
            formats:
            - format: 2006-01-02 15:04:05.000
        parseTruncated:
          - name: truncatedLog
            # 8k
            maxLength: 8192
    filters:
      - name: emptydirGetUid
        matchType: matchAll
        matchers:
          - empdirlog
        parsers:
          - getPodUid
          - getPodInfoByUid
      - name: kuberLogGetInfo
        matchType: matchAll
        matchers:
          - containerlog
        parsers:
          - getPodName
          - getPodInfoByName
      # truncated parser必须放到最后，其他parser要在这个parser之前
      - name: truncated
        matchType: matchAll
        matchers:
          - alllog
        parsers:
          - truncatedLog
  fliter_global.conf: |
    [FILTER]
        # 过滤空行
        Name        grep
        Match       *.log
        Exclude     \s+
  
    [FILTER]
        # 排除掉分隔符，标题型日志
        Name    grep
        Match   *
        Exclude ^(\*|=)+.*(\*|=)+$
  fluent-bit-db.conf: |
    [SERVICE]
        Flush         1
        # Log_Level     Trace
        Log_Level     info
        Daemon        off
        Parsers_File  parsers_parser.conf
        Parsers_File  parsers_db.conf
        HTTP_Server   On
        HTTP_Listen   0.0.0.0
        HTTP_Port     2020
        storage.path              ${FLUENT_FILESYSTEM_PATH}
        storage.sync              normal
        storage.checksum          off
        storage.backlog.mem_limit 100M
        scheduler.base   3
        scheduler.cap    600
  
    @INCLUDE input_db.conf
    @INCLUDE filter_*.conf
    @INCLUDE output_*.conf
  fluent-bit-k8s.conf: |
    [SERVICE]
        Flush         1
        # Log_Level     Trace
        Log_Level     info
        Daemon        off
        Parsers_File  parsers_parser.conf
        Parsers_File  parsers_db.conf
        storage.path              ${FLUENT_FILESYSTEM_PATH}
        storage.sync              normal
        storage.checksum          off
        storage.backlog.mem_limit 100M
        scheduler.base   3
        scheduler.cap    600
        HTTP_Server   On
        HTTP_Listen   0.0.0.0
        HTTP_Port     2020
  
    @INCLUDE input_k8s.conf
    @INCLUDE filter_*.conf
    @INCLUDE output_*.conf
  input_db.conf: |
    [INPUT]
        Name              tail
        Alias             es_log
        Tag               dbmotion.log
        Path              /var/lib/kubelet/pods/*/volumes/kubernetes.io~empty-dir/log-volume/*/dbmotion.log
        Multiline         On
        Multiline_Flush   5
        Parser_Firstline  dbmotion_parser
        Path_Key          logpath
        DB                /var/log/flb_dbmotion.db
        Mem_Buf_Limit     300MB
        Skip_Long_Lines   On
        Buffer_Max_Size   200k
        Buffer_Chunk_Size 100k
        Refresh_Interval  3
  input_k8s.conf: |
    [INPUT]
        Name              tail
        Tag               containerlog
        Alias             container_log
        Path              /var/log/containers/*.log
        Exclude_Path      /var/log/containers/*fluent-bit*.log,/var/log/containers/*kubevirt*.log
        Parser            ${FLUENT_CONTAINER_LOG_PARSER}
        Path_Key          logpath
        DB                /var/log/flb_kube.db
        Mem_Buf_Limit     500MB
        Buffer_Max_Size   800k
        storage.type  filesystem
        Buffer_Chunk_Size 700k
        Skip_Long_Lines   On
        Refresh_Interval  10
  limits.conf: |
    * soft nofile 65534
    * hard nofile 65534
    root soft nofile 65534
    root hard nofile 65534
  output_es.conf: |+
    [OUTPUT]
        Name            es
        Alias           es_log
        Match           *
        Host            ${FLUENT_ELASTICSEARCH_HOST}
        Port            9200
        Logstash_Format On
        Logstash_Prefix log
        Include_Tag_Key Off
        Retry_Limit     False
        Generate_ID     on
        Trace_Error     on
        storage.total_limit_size  ${FLUENT_FILESYSTEM_LIMIT_SIZE}
        Write_Operation upsert
        Logstash_Prefix_Key tag
  
  parsers_db.conf: |-
    [PARSER]
        Name        dbmotion_parser
        Format      json
  parsers_parser.conf: |+
    [PARSER]
        Name        docker
        Format      json
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L
        Time_Keep   On
        # Command      |  Decoder | Field | Optional Action
        # =============|==================|=================
        Decode_Field_As   escaped    log
  
    [PARSER]
        Name        cri
        Format      regex
        Regex       ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$
        Time_Key    time
        Time_Keep   On
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z
  
    [PARSER]
        Name        time_parser
        Format      regex
        Regex       ^(?<time>\d{4}-\d{2}-\d{2}[\S| ]\d{2}:\d{2}:\d{2}\.[\d|+|:]*)(?<log>(.|\n)*)
  
    [PARSER]
        Name        json_parser
        Format      json
---
# Source: fluentbit/templates/serviceaccount.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
    name: fluent-bit-read-dts
rules:
    - apiGroups: [""]
      resources:
          - namespaces
          - pods
      verbs: ["get", "list", "watch"]
---
# Source: fluentbit/templates/serviceaccount.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
    name: fluent-bit-read-dts
roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: fluent-bit-read-dts
subjects:
    - kind: ServiceAccount
      name: fluent-bit
      namespace: dts
---
# Source: fluentbit/templates/daemonset.yaml
# 采集数据库相关的日志
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentbit-database
  namespace: dts
  labels:
    helm.sh/chart: fluentbit-0.1.0
    app.kubernetes.io/name: fluentbit
    app.kubernetes.io/instance: fluentbit
    app.kubernetes.io/version: "1.4.5"
    app.kubernetes.io/managed-by: Helm
    type: database
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: fluentbit
      app.kubernetes.io/instance: fluentbit
      type: database
  template:
    metadata:
      labels:
        helm.sh/chart: fluentbit-0.1.0
        app.kubernetes.io/name: fluentbit
        app.kubernetes.io/instance: fluentbit
        app.kubernetes.io/version: "1.4.5"
        app.kubernetes.io/managed-by: Helm
        type: database
    spec:
      tolerations: 
        - effect: NoSchedule
          key: qfusion/master
          operator: Exists
        - effect: NoSchedule
          key: node-role.kubernetes.io/master
          operator: Exists
      containers:
        - name: fluent-bit
          image: k8smaster.qfusion.irds/irds/fluent-bit:2.0.9.1-hcs-oem
          imagePullPolicy: Always
          ports:
            - containerPort: 2020
          command: ["/fluent-bit/bin/fluent-bit", "-c", "/fluent-bit/etc/fluent-bit-db.conf"]
          env:
            - name: FLUENT_ELASTICSEARCH_HOST
              value: "elasticsearch-logging.dts.svc.cluster.local"
            - name: FLUENT_ELASTICSEARCH_PORT
              value: "9200"
            - name: FLUENT_FILESYSTEM_LIMIT_SIZE
              value: 10G
            - name: FLUENT_FILESYSTEM_PATH
              value: /flb-storage/database
            - name: FLUENT_CONTAINER_LOG_PARSER
              value: docker
          volumeMounts:
            - name: varlog
              mountPath: /var/log
            - name: varlibpodcontainers
              mountPath: /var/lib/kubelet/pods
              readOnly: true
            - name: fluent-bit-config
              mountPath: /fluent-bit/etc/
            - name: containers
              mountPath: /var/lib/docker/containers
              readOnly: true
            - name: limit
              mountPath: /etc/security/limits.conf
              subPath: limits
            - mountPath: /etc/localtime
              name: localtime
            - mountPath: /flb-storage
              name: storage
      terminationGracePeriodSeconds: 10
      volumes:
        - name: varlog
          hostPath:
            path: /var/log
        - name: storage
          hostPath:
            path: /opt/dts/flb-storage
        - name: varlibpodcontainers
          hostPath:
            path: /var/lib/kubelet/pods
        - name: containers
          hostPath:
              path: /var/lib/docker/containers
        - name: fluent-bit-config
          configMap:
            name: fluentbit
        - name: limit
          configMap:
            name: fluentbit
            items:
              - key: limits.conf
                path: limits
        - hostPath:
            path: /usr/share/zoneinfo/Asia/Shanghai
          name: localtime
      serviceAccountName: fluent-bit
---
# Source: fluentbit/templates/daemonset.yaml
# 采集k8s容器相关的日志
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentbit-k8s
  namespace: dts
  labels:
    helm.sh/chart: fluentbit-0.1.0
    app.kubernetes.io/name: fluentbit
    app.kubernetes.io/instance: fluentbit
    app.kubernetes.io/version: "1.4.5"
    app.kubernetes.io/managed-by: Helm
    type: k8s
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: fluentbit
      app.kubernetes.io/instance: fluentbit
      type: k8s
  template:
    metadata:
      labels:
        helm.sh/chart: fluentbit-0.1.0
        app.kubernetes.io/name: fluentbit
        app.kubernetes.io/instance: fluentbit
        app.kubernetes.io/version: "1.4.5"
        app.kubernetes.io/managed-by: Helm
        type: k8s
    spec:
      tolerations: 
        - effect: NoSchedule
          key: qfusion/master
          operator: Exists
        - effect: NoSchedule
          key: node-role.kubernetes.io/master
          operator: Exists
      containers:
        - name: fluent-bit
          image: k8smaster.qfusion.irds/irds/fluent-bit:2.0.9.1-hcs-oem
          imagePullPolicy: Always
          ports:
            - containerPort: 2020
          command: ["/fluent-bit/bin/fluent-bit", "-c", "/fluent-bit/etc/fluent-bit-k8s.conf"]
          env:
            - name: FLUENT_ELASTICSEARCH_HOST
              value: "elasticsearch-logging.dts.svc.cluster.local"
            - name: FLUENT_ELASTICSEARCH_PORT
              value: "9200"
            - name: FLUENT_FILESYSTEM_LIMIT_SIZE
              value: 10G
            - name: FLUENT_FILESYSTEM_PATH
              value: /flb-storage/k8s
            - name: FLUENT_CONTAINER_LOG_PARSER
              value: docker
          volumeMounts:
            - name: varlog
              mountPath: /var/log
            - name: varlibdockercontainers
              mountPath: /var/lib/docker/containers
              readOnly: true
            - name: fluent-bit-config
              mountPath: /fluent-bit/etc/
            - name: limit
              mountPath: /etc/security/limits.conf
              subPath: limits
            - mountPath: /etc/localtime
              name: localtime
            - mountPath: /flb-storage
              name: storage
      volumes:
        - name: varlog
          hostPath:
            path: /var/log
        - name: varlibdockercontainers
          hostPath:
            path: /var/lib/docker/containers
        - name: fluent-bit-config
          configMap:
            name: fluentbit
        - name: limit
          configMap:
            name: fluentbit
            items:
              - key: limits.conf
                path: limits
        - hostPath:
            path: /usr/share/zoneinfo/Asia/Shanghai
          name: localtime
        - name: storage
          hostPath:
            path: /opt/dts/flb-storage
      serviceAccountName: fluent-bit
---
# Source: grafana/templates/grafana-cofig.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-provisioning
data:
  datasources.yaml: |
    # config file version
    apiVersion: 1
    # list of datasources to insert/update depending
    # what's available in the database
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        orgId: 1
        url: http://monitor:9090
        # <bool> enable/disable basic auth
        basicAuth: false
        # <bool> enable/disable with credentials headers
        withCredentials: false
        # <bool> mark as default datasource. Max one per org
        isDefault: true
        version: 2
        # <bool> allow users to edit datasources from the UI.
        editable: true
  dashboards.yaml: |
    # # config file version
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        folderUid: ''
        type: file
        options:
          path: /var/lib/grafana/dashboards
  grafana.ini: |
    ##################### Grafana Configuration Defaults #####################
    #
    # Do not modify this file in grafana installs
    #

    # possible values : production, development
      app_mode = production

      # instance name, defaults to HOSTNAME environment variable value or hostname if HOSTNAME var is empty
      instance_name = ${HOSTNAME}

    #################################### Paths ###############################
      [paths]
    # Path to where grafana can store temp files, sessions, and the sqlite3 db (if that is used)
      data = data

      # Temporary files in `data` directory older than given duration will be removed
      temp_data_lifetime = 24h

      # Directory where grafana can store logs
      logs = data/log

      # Directory where grafana will automatically scan and look for plugins
      plugins = data/plugins

      # folder that contains provisioning config files that grafana will apply on startup and while running.
      provisioning = conf/provisioning

    #################################### Server ##############################
      [server]
    # Protocol (http, https, h2, socket)
      protocol = http

      # The ip address to bind to, empty will bind to all interfaces
      http_addr =

      # The http port to use
      http_port = 3000

      # The public facing domain name used to access grafana from a browser
      domain = 192.168.1.2

      # Redirect to correct domain if host header does not match domain
      # Prevents DNS rebinding attacks
      enforce_domain = false

      # The full public facing url
      root_url = %(protocol)s://%(domain)s:%(http_port)s/dts/grafana/

      # Serve Grafana from subpath specified in `root_url` setting. By default it is set to `false` for compatibility reasons.
      serve_from_sub_path = true

      # Log web requests
      router_logging = false

      # the path relative working path
      static_root_path = public

      # enable gzip
      enable_gzip = false

      # https certs & key file
      cert_file =
      cert_key =

      # Unix socket path
      socket = /var/run/grafana.sock

    #################################### Database ############################
      [database]
    # You can configure the database connection by specifying type, host, name, user and password
    # as separate properties or as on string using the url property.

    # Either "mysql", "postgres" or "sqlite3", it's your choice
      type = sqlite3
      host = 127.0.0.1:3306
      name = grafana
      user = root
      # If the password contains # or ; you have to wrap it with triple quotes. Ex """#password;"""
      password =
      # Use either URL or the previous fields to configure the database
      # Example: mysql://user:secret@host:port/database
      url =

      # Max idle conn setting default is 2
      max_idle_conn = 2

      # Max conn setting default is 0 (mean not set)
      max_open_conn =

      # Connection Max Lifetime default is 14400 (means 14400 seconds or 4 hours)
      conn_max_lifetime = 14400

      # Set to true to log the sql calls and execution times.
      log_queries =

      # For "postgres", use either "disable", "require" or "verify-full"
      # For "mysql", use either "true", "false", or "skip-verify".
      ssl_mode = disable

      ca_cert_path =
      client_key_path =
      client_cert_path =
      server_cert_name =

      # For "sqlite3" only, path relative to data_path setting
      path = grafana.db

      # For "sqlite3" only. cache mode setting used for connecting to the database
      cache_mode = private

    #################################### Cache server #############################
      [remote_cache]
    # Either "redis", "memcached" or "database" default is "database"
      type = database

      # cache connectionstring options
      # database: will use Grafana primary database.
      # redis: config like redis server e.g. `addr=127.0.0.1:6379,pool_size=100,db=0,ssl=false`. Only addr is required. ssl may be 'true', 'false', or 'insecure'.
      # memcache: 127.0.0.1:11211
      connstr =

    #################################### Data proxy ###########################
      [dataproxy]

    # This enables data proxy logging, default is false
      logging = false

      # How long the data proxy should wait before timing out default is 30 (seconds)
      timeout = 30

      # If enabled and user is not anonymous, data proxy will add X-Grafana-User header with username into the request, default is false.
      send_user_header = false

    #################################### Analytics ###########################
      [analytics]
    # Server reporting, sends usage counters to stats.grafana.org every 24 hours.
    # No ip addresses are being tracked, only simple counters to track
    # running instances, dashboard and error counts. It is very helpful to us.
    # Change this option to false to disable reporting.
      reporting_enabled = true

      # Set to false to disable all checks to https://grafana.com
      # for new versions (grafana itself and plugins), check is used
      # in some UI views to notify that grafana or plugin update exists
      # This option does not cause any auto updates, nor send any information
      # only a GET request to https://grafana.com to get latest versions
      check_for_updates = true

      # Google Analytics universal tracking code, only enabled if you specify an id here
      google_analytics_ua_id =

      # Google Tag Manager ID, only enabled if you specify an id here
      google_tag_manager_id =

    #################################### Security ############################
      [security]
    # disable creation of admin user on first start of grafana
      disable_initial_admin_creation = false

      # default admin user, created on startup
      admin_user = admin

      # default admin password, can be changed before first start of grafana, or in profile settings
      admin_password = Cljslrl0620

      # used for signing
      secret_key = SW2YcwTIb9zpOOhoPsMm

      # disable gravatar profile images
      disable_gravatar = true

      # data source proxy whitelist (ip_or_domain:port separated by spaces)
      data_source_proxy_whitelist =

      # disable protection against brute force login attempts
      disable_brute_force_login_protection = false

      # set to true if you host Grafana behind HTTPS. default is false.
      cookie_secure = false

      # set cookie SameSite attribute. defaults to `lax`. can be set to "lax", "strict" and "none"
      cookie_samesite = lax

      # set to true if you want to allow browsers to render Grafana in a <frame>, <iframe>, <embed> or <object>. default is false.
      allow_embedding = true

      # Set to true if you want to enable http strict transport security (HSTS) response header.
      # This is only sent when HTTPS is enabled in this configuration.
      # HSTS tells browsers that the site should only be accessed using HTTPS.
      # The default will change to true in the next minor release, 6.3.
      strict_transport_security = false

      # Sets how long a browser should cache HSTS. Only applied if strict_transport_security is enabled.
      strict_transport_security_max_age_seconds = 86400

      # Set to true if to enable HSTS preloading option. Only applied if strict_transport_security is enabled.
      strict_transport_security_preload = false

      # Set to true if to enable the HSTS includeSubDomains option. Only applied if strict_transport_security is enabled.
      strict_transport_security_subdomains = false

      # Set to true to enable the X-Content-Type-Options response header.
      # The X-Content-Type-Options response HTTP header is a marker used by the server to indicate that the MIME types advertised
      # in the Content-Type headers should not be changed and be followed. The default will change to true in the next minor release, 6.3.
      x_content_type_options = false

      # Set to true to enable the X-XSS-Protection header, which tells browsers to stop pages from loading
      # when they detect reflected cross-site scripting (XSS) attacks. The default will change to true in the next minor release, 6.3.
      x_xss_protection = false

    #################################### Dashboards ##################

      [dashboards]
    # Number dashboard versions to keep (per dashboard). Default: 20, Minimum: 1
      versions_to_keep = 20

    #################################### Users ###############################
      [users]
    # disable user signup / registration
      allow_sign_up = true

      # Allow non admin users to create organizations
      allow_org_create = true

      # Set to true to automatically assign new users to the default organization (id 1)
      auto_assign_org = true

      # Set this value to automatically add new users to the provided organization (if auto_assign_org above is set to true)
      auto_assign_org_id = 1

      # Default role new users will be automatically assigned (if auto_assign_org above is set to true)
      auto_assign_org_role = Viewer

      # Require email validation before sign up completes
      verify_email_enabled = false

      # Background text for the user field on the login page
      login_hint = email or username
      password_hint = password

      # Default UI theme ("dark" or "light")
      default_theme = light

      # External user management
      external_manage_link_url =
      external_manage_link_name =
      external_manage_info =

      # Viewers can edit/inspect dashboard settings in the browser. But not save the dashboard.
      viewers_can_edit = false

      # Editors can administrate dashboard, folders and teams they create
      editors_can_admin = false

      [auth]
    # Login cookie name
      login_cookie_name = grafana_session

      # The lifetime (days) an authenticated user can be inactive before being required to login at next visit. Default is 7 days.
      login_maximum_inactive_lifetime_days = 7

      # The maximum lifetime (days) an authenticated user can be logged in since login time before being required to login. Default is 30 days.
      login_maximum_lifetime_days = 30

      # How often should auth tokens be rotated for authenticated users when being active. The default is each 10 minutes.
      token_rotation_interval_minutes = 10

      # Set to true to disable (hide) the login form, useful if you use OAuth
      disable_login_form = false

      # Set to true to disable the signout link in the side menu. useful if you use auth.proxy
      disable_signout_menu = false

      # URL to redirect the user to after sign out
      signout_redirect_url =

      # Set to true to attempt login with OAuth automatically, skipping the login screen.
      # This setting is ignored if multiple OAuth providers are configured.
      oauth_auto_login = false

      # limit of api_key seconds to live before expiration
      api_key_max_seconds_to_live = -1

    #################################### Anonymous Auth ######################
      [auth.anonymous]
    # enable anonymous access
      enabled = true

      # specify organization name that should be used for unauthenticated users
      org_name = Main Org.

      # specify role for unauthenticated users
      org_role = Viewer



    #################################### Basic Auth ##########################
      [auth.basic]
      enabled = true


    #################################### Logging ##########################
      [log]
    # Either "console", "file", "syslog". Default is console and file
    # Use space to separate multiple modes, e.g. "console file"
      mode = console file

      # Either "debug", "info", "warn", "error", "critical", default is "info"
      level = info

      # optional settings to set different levels for specific loggers. Ex filters = sqlstore:debug
      filters =

    # For "console" mode only
      [log.console]
      level =

      # log line format, valid options are text, console and json
      format = console

    # For "file" mode only
      [log.file]
      level =

      # log line format, valid options are text, console and json
      format = text

      # This enables automated log rotate(switch of following options), default is true
      log_rotate = true

      # Max line number of single file, default is 1000000
      max_lines = 1000000

      # Max size shift of single file, default is 28 means 1 << 28, 256MB
      max_size_shift = 28

      # Segment log daily, default is true
      daily_rotate = true

      # Expired days of log file(delete after max days), default is 7
      max_days = 7

      [log.syslog]
      level =

      # log line format, valid options are text, console and json
      format = text

      # Syslog network type and address. This can be udp, tcp, or unix. If left blank, the default unix endpoints will be used.
      network =
      address =

      # Syslog facility. user, daemon and local0 through local7 are valid.
      facility =

      # Syslog tag. By default, the process' argv[0] is used.
      tag =

    #################################### Usage Quotas ########################
      [quota]
      enabled = false

      #### set quotas to -1 to make unlimited. ####
      # limit number of users per Org.
      org_user = 10

      # limit number of dashboards per Org.
      org_dashboard = 100

      # limit number of data_sources per Org.
      org_data_source = 10

      # limit number of api_keys per Org.
      org_api_key = 10

      # limit number of orgs a user can create.
      user_org = 10

      # Global limit of users.
      global_user = -1

      # global limit of orgs.
      global_org = -1

      # global limit of dashboards
      global_dashboard = -1

      # global limit of api_keys
      global_api_key = -1

      # global limit on number of logged in users.
      global_session = -1

    #################################### Alerting ############################
      [alerting]
    # Disable alerting engine & UI features
      enabled = true
      # Makes it possible to turn off alert rule execution but alerting UI is visible
      execute_alerts = true

      # Default setting for new alert rules. Defaults to categorize error and timeouts as alerting. (alerting, keep_state)
      error_or_timeout = alerting

      # Default setting for how Grafana handles nodata or null values in alerting. (alerting, no_data, keep_state, ok)
      nodata_or_nullvalues = no_data

      # Alert notifications can include images, but rendering many images at the same time can overload the server
      # This limit will protect the server from render overloading and make sure notifications are sent out quickly
      concurrent_render_limit = 5

      # Default setting for alert calculation timeout. Default value is 30
      evaluation_timeout_seconds = 30

      # Default setting for alert notification timeout. Default value is 30
      notification_timeout_seconds = 30

      # Default setting for max attempts to sending alert notifications. Default value is 3
      max_attempts = 3


    #################################### Explore #############################
      [explore]
    # Enable the Explore section
      enabled = true

    #################################### Internal Grafana Metrics ############
    # Metrics available at HTTP API Url /metrics
      [metrics]
      enabled              = true
      interval_seconds     = 10
      # Disable total stats (stat_totals_*) metrics to be generated
      disable_total_stats = false

      #If both are set, basic auth will be required for the metrics endpoint.
      basic_auth_username =
      basic_auth_password =

    # Send internal Grafana metrics to graphite
      [metrics.graphite]
    # Enable by setting the address setting (ex localhost:2003)
      address =
      prefix = prod.grafana.%(instance_name)s.

      [grafana_net]
      url = https://grafana.com

      [grafana_com]
      url = https://grafana.com

      [panels]
    # here for to support old env variables, can remove after a few months
      enable_alpha = false
      disable_sanitize_html = false

      [plugins]
      enable_alpha = false
      app_tls_skip_verify_insecure = false

      [feature_toggles]
    # enable features, separated by spaces
      enable =
---
# Source: grafana/templates/grafana-dashboards.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: dts
data:
  dts-full-migration.json: |-
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "target": {
              "limit": 100,
              "matchAny": false,
              "tags": [],
              "type": "dashboard"
            },
            "type": "dashboard"
          }
        ]
      },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "每秒钟读写行数",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 1,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 9,
            "w": 12,
            "x": 0,
            "y": 0
          },
          "id": 2,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "rate(dts_data_row_count{event_type=\"read\", task_id=\"$task_id\"}[5m])",
              "legendFormat": "读取源端",
              "range": true,
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "code",
              "expr": "rate(dts_data_row_count{event_type=\"write\", task_id=\"$task_id\"}[5m])",
              "hide": false,
              "legendFormat": "写入目标端",
              "range": true,
              "refId": "B"
            }
          ],
          "title": "RPS",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "每秒钟读写的数据量",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "binBps"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 9,
            "w": 12,
            "x": 12,
            "y": 0
          },
          "id": 6,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "code",
              "expr": "rate(dts_data_bytes{event_type=\"read\", task_id=\"$task_id\"}[5m])",
              "legendFormat": "读取源端",
              "range": true,
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "code",
              "expr": "rate(dts_data_bytes{event_type=\"write\", task_id=\"$task_id\"}[5m])",
              "hide": false,
              "legendFormat": "写入目标端",
              "range": true,
              "refId": "B"
            }
          ],
          "title": "Throughput",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "每秒钟处理的事务数",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 9
          },
          "id": 10,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "code",
              "expr": "rate(dts_data_transaction_count{event_type=\"read\", task_id=\"$task_id\"}[5m])",
              "legendFormat": "读取源端",
              "range": true,
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "code",
              "expr": "rate(dts_data_transaction_count{event_type=\"write\", task_id=\"$task_id\"}[5m])",
              "hide": false,
              "legendFormat": "写入目标端",
              "range": true,
              "refId": "B"
            }
          ],
          "title": "TPS",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "数据库响应时间",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "ms"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 9
          },
          "id": 8,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "builder",
              "expr": "dts_data_sql_response_time{event_type=\"read\", task_id=\"$task_id\"}",
              "legendFormat": "源端",
              "range": true,
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "builder",
              "expr": "dts_data_sql_response_time{event_type=\"write\", task_id=\"$task_id\"}",
              "hide": false,
              "legendFormat": "目标端",
              "range": true,
              "refId": "B"
            }
          ],
          "title": "Database Response Time",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "缓存的行数",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 17
          },
          "id": 12,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "code",
              "expr": "max(dts_data_row_count{event_type=\"read\", task_id=\"$task_id\"}) - min(dts_data_row_count{event_type=\"write\", task_id=\"$task_id\"})",
              "legendFormat": "缓存的行数",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Queued Rows",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "网络延时",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "ms"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 17
          },
          "id": 14,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "builder",
              "expr": "dts_network_delay{end_type=\"source\", task_id=\"$task_id\"}",
              "legendFormat": "源端",
              "range": true,
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "builder",
              "expr": "dts_network_delay{end_type=\"target\", task_id=\"$task_id\"}",
              "hide": false,
              "legendFormat": "目标端",
              "range": true,
              "refId": "B"
            }
          ],
          "title": "Network Delay",
          "type": "timeseries"
        }
      ],
      "refresh": false,
      "schemaVersion": 37,
      "style": "dark",
      "tags": [],
      "templating": {
        "list": [
          {
            "current": {
              "selected": false,
              "text": "42933b995114",
              "value": "42933b995114"
            },
            "datasource": {
              "type": "prometheus",
              "uid": "PBFA97CFB590B2093"
            },
            "definition": "label_values(task_id)",
            "hide": 2,
            "includeAll": false,
            "label": "task_id",
            "multi": false,
            "name": "task_id",
            "options": [],
            "query": {
              "query": "label_values(task_id)",
              "refId": "StandardVariableQuery"
            },
            "refresh": 1,
            "regex": "",
            "skipUrlSync": false,
            "sort": 0,
            "type": "query"
          }
        ]
      },
      "time": {
        "from": "now-30m",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "",
      "title": "full migration",
      "uid": "rKMxvp24k",
      "version": 1,
      "weekStart": ""
    }
  dts-sync-migration.json: |-
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "target": {
              "limit": 100,
              "matchAny": false,
              "tags": [],
              "type": "dashboard"
            },
            "type": "dashboard"
          }
        ]
      },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 0
          },
          "id": 2,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "builder",
              "expr": "dts_binlog_delay{event_type=\"write\", task_id=\"$task_id\"}",
              "legendFormat": "写目标端",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Write Delay(RTO)",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 0
          },
          "id": 4,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "builder",
              "expr": "dts_binlog_delay{event_type=\"read\", task_id=\"$task_id\"}",
              "legendFormat": "读取源端",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Read Delay(RPO)",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "每秒钟同步的行数",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 8
          },
          "id": 6,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "code",
              "expr": "rate(dts_binlog_row_count{event_type=\"read\", task_id=\"$task_id\"}[30s])",
              "legendFormat": "读取源端",
              "range": true,
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "code",
              "expr": "rate(dts_binlog_row_count{event_type=\"write\", task_id=\"$task_id\"}[30s])",
              "hide": false,
              "legendFormat": "写目标端",
              "range": true,
              "refId": "B"
            }
          ],
          "title": "RPS",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "每秒钟同步的数据量",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "binBps"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 8
          },
          "id": 8,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "code",
              "expr": "rate(dts_binlog_bytes{event_type=\"read\", task_id=\"$task_id\"}[30s])",
              "legendFormat": "读取源端",
              "range": true,
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "code",
              "expr": "rate(dts_binlog_bytes{event_type=\"write\", task_id=\"$task_id\"}[30s])",
              "hide": false,
              "legendFormat": "写目标端",
              "range": true,
              "refId": "B"
            }
          ],
          "title": "Throughput",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "每秒钟处理的事务数",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 16
          },
          "id": 10,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "code",
              "expr": "rate(dts_binlog_transaction_count{event_type=\"read\", task_id=\"$task_id\"}[1m])",
              "legendFormat": "读取源端",
              "range": true,
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "code",
              "expr": "rate(dts_binlog_transaction_count{event_type=\"write\", task_id=\"$task_id\"}[1m])",
              "hide": false,
              "legendFormat": "写目标端",
              "range": true,
              "refId": "B"
            }
          ],
          "title": "TPS",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "数据库响应时间",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "ms"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 16
          },
          "id": 12,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "builder",
              "expr": "dts_binlog_sql_response_time{event_type=\"read\", task_id=\"$task_id\"}",
              "legendFormat": "源端",
              "range": true,
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "builder",
              "expr": "dts_binlog_sql_response_time{event_type=\"write\", task_id=\"$task_id\"}",
              "hide": false,
              "legendFormat": "目标端",
              "range": true,
              "refId": "B"
            }
          ],
          "title": "Database Response Time",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "缓存的行数",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 24
          },
          "id": 14,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "code",
              "expr": "max(dts_binlog_row_count{event_type=\"read\", task_id=\"$task_id\"}) - min(dts_binlog_row_count{event_type=\"write\", task_id=\"$task_id\"}) - min(dts_binlog_row_count{event_type=\"skip\", task_id=\"$task_id\"})",
              "legendFormat": "缓存的行数",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Queued Rows",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "网络延时",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "ms"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 24
          },
          "id": 16,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "code",
              "expr": "dts_network_delay{end_type=\"source\", task_id=\"$task_id\"}",
              "legendFormat": "源端",
              "range": true,
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus"
              },
              "editorMode": "code",
              "expr": "dts_network_delay{end_type=\"target\", task_id=\"$task_id\"}",
              "hide": false,
              "legendFormat": "目标端",
              "range": true,
              "refId": "B"
            }
          ],
          "title": "Network Delay",
          "type": "timeseries"
        }
      ],
      "refresh": false,
      "schemaVersion": 37,
      "style": "dark",
      "tags": [],
      "templating": {
        "list": [
          {
            "current": {
              "selected": false,
              "text": "42933b995114",
              "value": "42933b995114"
            },
            "datasource": {
              "type": "prometheus",
              "uid": "PBFA97CFB590B2093"
            },
            "definition": "label_values(task_id)",
            "hide": 2,
            "includeAll": false,
            "label": "task_id",
            "multi": false,
            "name": "task_id",
            "options": [],
            "query": {
              "query": "label_values(task_id)",
              "refId": "StandardVariableQuery"
            },
            "refresh": 1,
            "regex": "",
            "skipUrlSync": false,
            "sort": 0,
            "type": "query"
          }
        ]
      },
      "time": {
        "from": "now-30m",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "",
      "title": "sync migration",
      "uid": "x6apn22Vk",
      "version": 1,
      "weekStart": ""
    }
---
# Source: grafana/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: dts
  annotations:
    prometheus.io/scrape: 'true'
  labels:
    app.kubernetes.io/name: grafana
spec:
  selector:
    app.kubernetes.io/name: grafana
  ports:
    - name: grafana
      protocol: TCP
      port: 3000
  type: ClusterIP
---
# Source: grafana/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: dts
  labels:
    app.kubernetes.io/name: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: grafana
  template:
    metadata:
      annotations:
        grafana-version: '1.0'
      name: grafana
      labels:
        app.kubernetes.io/name: grafana
    spec:
      containers:
        - name: grafana
          image: k8smaster.qfusion.irds/irds/grafana:10.1.1
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsUser: 0
          env:
            - name: GF_SECURITY_ADMIN_PASSWORD
              value: admin
            - name: GF_AUTH_ANONYMOUS_ENABLED
              value: "true"
            - name: GF_SECURITY_ALLOW_EMBEDDING
              value: "true"
          ports:
            - name: grafana
              containerPort: 3000
          resources:
            {}
          volumeMounts:
            - name: grafana-provisioning
              mountPath: /etc/grafana/provisioning/datasources/datasources.yaml
              subPath: datasources.yaml
            - name: grafana-provisioning
              mountPath: /etc/grafana/provisioning/dashboards/dashboards.yaml
              subPath: dashboards.yaml
            - name: grafana-dashboards
              mountPath: /var/lib/grafana/dashboards/
            - name: grafana-provisioning
              mountPath: /etc/grafana/grafana.ini
              subPath: grafana.ini
            
      volumes:
        - name: grafana-dashboards
          configMap:
            name: grafana-dashboards
        - name: grafana-provisioning
          configMap:
            name: grafana-provisioning
        
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                  - dts-grafana
              topologyKey: kubernetes.io/hostname
            weight: 1
      tolerations: 
        - effect: NoSchedule
          key: node-role.kubernetes.io/master
          operator: Exists
---
# Source: istio/templates/auth.yaml
kind: ConfigMap
apiVersion: v1
data:
  conf.sql: |
      INSERT INTO `casbin_rule` VALUES ('p','anonymous','api','/dts','GET','Y','',''),
                                     ('p','anonymous','api','/dts/grafana','POST','Y','',''),
                                     ('p','anonymous','api','/api/motion','GET','Y','',''),
                                     ('p','anonymous','api','/api/motion','POST','Y','',''),
                                     ('p','anonymous','api','/api/motion','PUT','Y','',''),
                                     ('p','anonymous','api','/api/motion','DELETE','Y','','');

# 3.13.10开始每个版本新增的权限新加一个conf.sql,例如conf01.conf、conf02.sql、conf03.sql以此类推
# auth-config-v0.0.1 configmap annotations:history-sql-file: '{"conf.sql":true}' 这边会记录历史的sql，执行过的将不再重复执行
# casbin sql语句顺序往下面加，不要在上面做修改删除新增操作，会影响adminUser的权限
# user,department,admin 这三个角色的权限会走继承关系，adminUser是单独的，需要单独给adminUser加权限
metadata:
  name: auth-config-v0.0.1
  namespace: dts
  annotations:
    history-sql-file: '{"conf.sql": true}'
  labels:
    install.woqutech.com/managed-by: qfusion-installer-operator
    install.woqutech.com/package: qfusion-webserver
---
# Source: istio/templates/auth.yaml
apiVersion: v1
kind: Service
metadata:
  name: auth
  namespace: dts
  annotations:
  labels:
    app.kubernetes.io/name: auth
    install.woqutech.com/managed-by: qfusion-installer-operator
    install.woqutech.com/package: qfusion-webserver
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: auth
  ports:
    - name: http-auth
      port: 9095
      protocol: TCP
      targetPort: 9095
    - name: http-user
      port: 9096
      protocol: TCP
      targetPort: 9096
---
# Source: istio/templates/web_ingress.yaml
apiVersion: v1
kind: Service
metadata:
  name: dts-ingressgateway
  namespace: dts
  annotations:
  labels:
    app: dts-ingressgateway
spec:
  type: ClusterIP
  selector:
    app: dts-ingressgateway
  ports:
    - name: http-web
      port: 80
      protocol: TCP
      targetPort: 8080
---
# Source: istio/templates/auth.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth
  namespace: dts
  labels:
    app.kubernetes.io/name: auth
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app.kubernetes.io/name: auth
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      name: auth
      annotations:
        sidecar.istio.io/inject: "y"
      creationTimestamp: null
      labels:
        app.kubernetes.io/name: auth
        qfusion/useIstio: "true"
    spec:
      containers:
        - args:
            - --dbAddr=$(DATABASE_USERNAME):$(DATABASE_PASSWORD)@tcp(qfusion-cmdb0.qfusion:3306)/webserver?parseTime=true&timeout=5s&readTimeout=6s&charset=utf8&parseTime=true&loc=Local
            - --destAddr=http://dts-ingressgateway
            - --innerAddr=0.0.0.0:9096
            - --captchaCheck=true
            - --homeUrl=/dts
            - --logtostderr
            - --casServer=https://auth.songshanghu-x86-2.com/authui
            - --skipVerify=true
            - --hcsToken=true
            - --paramWhiteList=homeUrl,state,service,region,home,origin
            - --defaultDepartment=mo
            - --useRsaClient=true
            - --hcsDepartment=true
            - --sessionApiPrefix=/prometheus
            - --whiteListPrefix=/prometheus
          env:
            - name: NAMESPACE
              value: dts
            - name: DATABASE_USERNAME
              valueFrom:
                secretKeyRef:
                  key: username
                  name: cmdb0-root-suffix
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: cmdb0-root-suffix
          image: k8smaster.qfusion.irds/irds/auth:v1.0
          imagePullPolicy: IfNotPresent
          name: auth
          ports:
            - containerPort: 9095
              name: auth
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /auth/v1/reload
              port: 9095
              scheme: HTTP
            periodSeconds: 15
            successThreshold: 1
            timeoutSeconds: 1
          resources: {}
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
            - mountPath: /etc/conf
              name: auth-config
            - mountPath: /etc/localtime
              name: localtime
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      serviceAccount: dboperator
      serviceAccountName: dboperator
      terminationGracePeriodSeconds: 0
      tolerations:
        - effect: NoExecute
          key: qfusion/master
          operator: Exists
        - effect: NoExecute
          key: node-role.kubernetes.io/master
          operator: Exists
          tolerationSeconds: 60
      volumes:
        - configMap:
            defaultMode: 420
            name: auth-config-v0.0.1
          name: auth-config
        - hostPath:
            path: /usr/share/zoneinfo/Asia/Shanghai
            type: ""
          name: localtime
---
# Source: istio/templates/web_ingress.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dts-ingressgateway
  namespace: dts
  labels:
    app: dts-ingressgateway
    operator.istio.io/component: "dts-IngressGateways"
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: dts-ingressgateway
  strategy:
    rollingUpdate:
      maxSurge: 100%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: dts-ingressgateway
      annotations:
        prometheus.io/port: "15020"
        prometheus.io/scrape: "true"
        prometheus.io/path: "/stats/prometheus"
        sidecar.istio.io/inject: "false"
    spec:
      securityContext:
        runAsUser: 1337
        runAsGroup: 1337
        runAsNonRoot: true
        fsGroup: 1337
      tolerations:
        - effect: NoExecute
          key: qfusion/master
          operator: Exists
        - effect: NoExecute
          key: node-role.kubernetes.io/master
          operator: Exists
          tolerationSeconds: 60
      containers:
        - name: istio-proxy
          image: "k8smaster.qfusion.irds/irds/proxyv2:1.17.2-distroless"
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 80
              protocol: TCP
              name: qfusion-web
          args:
            - proxy
            - router
            - --domain
            - $(POD_NAMESPACE).svc.cluster.local
            - --proxyLogLevel=warning
            - --proxyComponentLogLevel=misc:error
            - --log_output_level=default:info
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          readinessProbe:
            failureThreshold: 30
            httpGet:
              path: /healthz/ready
              port: 15021
              scheme: HTTP
            initialDelaySeconds: 1
            periodSeconds: 2
            successThreshold: 1
            timeoutSeconds: 1
          resources:
            limits:
              cpu: 2000m
              memory: 1024Mi
            requests:
              cpu: 100m
              memory: 128Mi
          env:
            - name: JWT_POLICY
              value: first-party-jwt
            - name: PILOT_CERT_PROVIDER
              value: istiod
            - name: CA_ADDR
              value: istiod.qfusion.svc:15012
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: INSTANCE_IP
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: status.podIP
            - name: HOST_IP
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: status.hostIP
            - name: SERVICE_ACCOUNT
              valueFrom:
                fieldRef:
                  fieldPath: spec.serviceAccountName
            - name: ISTIO_META_WORKLOAD_NAME
              value: web-ingressgateway
            - name: ISTIO_META_OWNER
              value: kubernetes://apis/apps/v1/namespaces/qfusion/deployments/istio-ingressgateway
            - name: ISTIO_META_MESH_ID
              value: "cluster.local"
            - name: TRUST_DOMAIN
              value: "cluster.local"
            - name: ISTIO_META_UNPRIVILEGED_POD
              value: "true"
            - name: ISTIO_AGENT_DUAL_STACK
              value: "true"
            - name: ISTIO_META_CLUSTER_ID
              value: "Kubernetes"
            - name: ISTIO_META_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
          volumeMounts:
            - name: workload-socket
              mountPath: /var/run/secrets/workload-spiffe-uds
            - name: credential-socket
              mountPath: /var/run/secrets/credential-uds
            - name: workload-certs
              mountPath: /var/run/secrets/workload-spiffe-credentials
            - name: istio-envoy
              mountPath: /etc/istio/proxy
            - name: config-volume
              mountPath: /etc/istio/config
            - mountPath: /var/run/secrets/istio
              name: istiod-ca-cert
            - mountPath: /var/lib/istio/data
              name: istio-data
            - name: podinfo
              mountPath: /etc/istio/pod
            - name: ingressgateway-certs
              mountPath: "/etc/istio/ingressgateway-certs"
              readOnly: true
            - name: ingressgateway-ca-certs
              mountPath: "/etc/istio/ingressgateway-ca-certs"
              readOnly: true
      volumes:
        - emptyDir: {}
          name: workload-socket
        - emptyDir: {}
          name: credential-socket
        - emptyDir: {}
          name: workload-certs
        - name: istiod-ca-cert
          configMap:
            defaultMode: 420
            name: istio-ca-root-cert
        - name: podinfo
          downwardAPI:
            items:
              - path: "labels"
                fieldRef:
                  fieldPath: metadata.labels
              - path: "annotations"
                fieldRef:
                  fieldPath: metadata.annotations
        - name: istio-envoy
          emptyDir: {}
        - name: istio-data
          emptyDir: {}
        - name: config-volume
          configMap:
            name: istio
            optional: true
        - name: ingressgateway-certs
          secret:
            secretName: "istio-ingressgateway-certs"
            optional: true
        - name: ingressgateway-ca-certs
          secret:
            secretName: "istio-ingressgateway-ca-certs"
            optional: true
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      serviceAccount: dboperator
      serviceAccountName: dboperator
      terminationGracePeriodSeconds: 0
---
# Source: istio/templates/gateway.yaml
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  generation: 1
  labels:
    kiali_wizard: web-Gateway
  name: webserver
  namespace: dts
spec:
  selector:
    app: dts-ingressgateway
  servers:
  - hosts:
    - '*'
    port:
      name: http-web
      number: 80
      protocol: HTTP
---
# Source: istio/templates/gen_all_vs.yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: dts
  namespace: dts
  labels:
    install.woqutech.com/managed-by: qfusion-installer-operator
    install.woqutech.com/package: qfusion-istio
spec:
  hosts:
    - '*'
  gateways:
  - qfusion/auth
  http:
  - match:
    - uri:
        prefix: /dts/grafana
    route:
    - destination:
        host: auth.dts.svc.cluster.local
        port:
          number: 9095
  - match:
    - uri:
        prefix: /dts
    - uri:
        prefix: /upload
    - uri:
        prefix: /*.(jpg|png)
    route:
    - destination:
        host: dts-ui.dts.svc.cluster.local
        port:
          number: 8080
  - match:
    - uri:
        prefix: /api/motion
    route:
    - destination:
        host: auth.dts.svc.cluster.local
        port:
          number: 9095
---
# Source: istio/templates/gen_all_vs.yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: dts-api-server
  namespace: dts
  labels:
    install.woqutech.com/managed-by: qfusion-installer-operator
    install.woqutech.com/package: qfusion-istio
spec:
  hosts:
    - '*'
  gateways:
  - webserver
  http:
  - match:
    - uri:
        prefix: /api/motion
    route:
    - destination:
        host: dts-api-server.dts.svc.cluster.local
        port:
          number: 3000
  - match:
      - uri:
          prefix: /dts/grafana
    route:
      - destination:
          host: grafana.dts.svc.cluster.local
          port:
            number: 3000
---
# Source: monitor/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: monitor
---
# Source: monitor/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-tmpl
  namespace: dts
data:
  email.tmpl: |-
    <!doctype html>
    <html>
    <head>
        <meta name="viewport" content="width=device-width"/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <title>告警模板</title>
        <style>
            /* GLOBAL RESETS */
            body {
                margin: 0;
                padding: 0;
                background-color: #F8F8F8;
                line-height: 20px;
                -webkit-font-smoothing: antialiased;
                font-family: sans-serif;
                font-size: 13px;
                -webkit-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
                color: #333
            }
    
            img {
                border: none;
                -ms-interpolation-mode: bicubic;
                max-width: 100%;
                vertical-align: middle
            }
    
            table {
                width: 100%;
                border-collapse: separate;
                mso-table-lspace: 0;
                mso-table-rspace: 0
            }
    
            table td {
                font-family: sans-serif;
                font-size: 13px;
                vertical-align: top
            }
    
            h1, h2, h3, h4 {
                margin: 0 0 30px;
                line-height: 1.4;
                color: #000;
                font-family: sans-serif;
                font-weight: 400
            }
    
            h1 {
                font-size: 35px;
                font-weight: 300;
                text-align: center;
                text-transform: capitalize
            }
    
            p, ul, ol {
                margin: 0 0 15px;
                font-family: sans-serif;
                font-size: 13px;
                font-weight: 400
            }
    
            p li, ul li, ol li {
                list-style-position: inside;
                margin-left: 5px
            }
    
            a {
                color: #3498DB;
                text-decoration: underline
            }
    
            hr {
                margin: 20px 0;
                border: 0;
                border-bottom: 1px solid #F8F8F8
            }
    
            /* BODY & CONTAINER */
            .body {
                width: 100%;
                background-color: #F8F8F8
            }
    
            .container {
                display: block;
                width: auto !important;
                width: 900px;
                margin: 0 auto !important;
                padding: 10px 0;
                max-width: 900px;
                box-sizing: border-box;
            }
    
            .content {
                display: block;
                margin: 0 auto;
                padding: 10px 0;
                box-sizing: border-box;
                max-width: 900px
            }
    
            /* HEADER, FOOTER, MAIN */
            .main {
                width: 100%;
                background: #FFF;
                border-radius: 3px
            }
    
            .wrapper {
                padding: 15px 25px 40px 0;
                box-sizing: border-box
            }
    
            .footer {
                clear: both;
                width: 100%;
                padding-top: 10px;
                text-align: center
            }
    
            .footer td, .footer p, .footer span, .footer a {
                color: #999;
                font-size: 12px;
                text-align: center
            }
    
            /* BUTTONS */
            .btn {
                width: 100%;
                box-sizing: border-box
            }
    
            .btn > tbody > tr > td {
                padding-bottom: 15px
            }
    
            .btn table {
                width: auto
            }
    
            .btn table td {
                background-color: #FFF;
                text-align: center;
                border-radius: 5px
            }
    
            .btn a {
                display: inline-block;
                margin: 0;
                padding: 12px 25px;
                border: solid 1px #3498DB;
                background-color: #FFF;
                color: #3498DB;
                font-size: 13px;
                font-weight: 700;
                text-decoration: none;
                cursor: pointer;
                border-radius: 5px;
                box-sizing: border-box;
                text-transform: capitalize
            }
    
            .btn-primary table td {
                background-color: #3498DB
            }
    
            .btn-primary a {
                border-color: #3498DB;
                background-color: #3498DB;
                color: #FFF
            }
    
            /* OTHER STYLES THAT MIGHT BE USEFUL */
            .align-center {
                text-align: center
            }
    
            .align-right {
                text-align: right
            }
    
            .align-left {
                text-align: left
            }
    
            .clear {
                clear: both
            }
    
            .mt0 {
                margin-top: 0
            }
    
            .mb0 {
                margin-bottom: 0
            }
    
            .preheader {
                display: none;
                width: 0;
                height: 0;
                color: transparent;
                max-height: 0;
                max-width: 0;
                opacity: 0;
                overflow: hidden;
                visibility: hidden
            }
    
            .powered-by a {
                text-decoration: none
            }
    
            /* RESPONSIVE AND MOBILE FRIENDLY STYLES */
            @media only screen and (max-width: 620px) {
                table[class=body] h1 {
                    margin-bottom: 10px !important;
                    font-size: 28px !important
                }
    
                table[class=body] p, table[class=body] ul, table[class=body] ol, table[class=body] td, table[class=body] span, table[class=body] a {
                    font-size: 16px !important
                }
    
                table[class=body] .wrapper, table[class=body] .article {
                    padding: 10px !important
                }
    
                table[class=body] .content {
                    padding: 0 !important
                }
    
                table[class=body] .container {
                    width: 100% !important;
                    padding: 0 !important
                }
    
                table[class=body] .main {
                    border-left-width: 0 !important;
                    border-right-width: 0 !important;
                    border-radius: 0 !important
                }
    
                table[class=body] .btn table, table[class=body] .btn a {
                    width: 100% !important
                }
    
                table[class=body] .img-responsive {
                    width: auto !important;
                    height: auto !important;
                    max-width: 100% !important
                }
            }
    
            /* PRESERVE THESE STYLES IN THE HEAD */
            @media all {
                .ExternalClass {
                    width: 100%
                }
    
                .ExternalClass, .ExternalClass p, .ExternalClass span, .ExternalClass font, .ExternalClass td, .ExternalClass div {
                    line-height: 100%
                }
    
                .apple-link a {
                    line-height: inherit !important;
                    color: inherit !important;
                    font-family: inherit !important;
                    font-size: inherit !important;
                    font-weight: inherit !important;
                    text-decoration: none !important
                }
    
                .btn-primary table td:hover {
                    background-color: #34495E !important
                }
    
                .btn-primary a:hover {
                    border-color: #34495E !important;
                    background-color: #34495E !important
                }
            }
    
            /* common */
            .alert {
                padding: 16px 25px;
                color: #FFF;
                font-size: 16px;
                font-weight: 500;
                text-align: left
            }
    
            .alert .text {
                margin-left: 10px
            }
    
            .alert.alert--bad {
                background-color: #FD6969
            }
    
            .alert.alert--resolved {
                background-color: #28d280
            }
    
            .greeting {
                margin-bottom: 10px;
                padding: 5px 0 5px 25px;
            }
    
            .alert-item-title {
                width: 100px;
                padding: 8px 0 0 25px;
            }
    
            .alert-item-context {
                padding: 8px 20px;
                background-color: #F8F8F8;
                color: #666
            }
    
            .alert-item-space {
                height: 15px;
                line-height: 1
            }
    
            .alert-hr-top, .alert-hr-bottom {
                height: 40px;
            }
    
            .alert-hr-line {
                line-height: 0
            }
    
            .alert-hr-line p {
                width: 100%;
                height: 1px;
                margin: 0;
                padding: 0;
                background-color: #EBEBEB;
                overflow: hidden
            }
    
            .level--warnning {
    
                color: #FF9F00
            }
    
            .level--critical {
                color: #FD6969
            }
    
            .alert-hr {
                padding-left: 25px;
            }
    
            .alert-item-title--bad {
                border-left: 3px solid #FD6969;
            }
    
            .alert-item-title--resolved {
                border-left: 3px solid #28D280;
            }
        </style>
    </head>
    <body class="">
    <table border="0" cellpadding="0" cellspacing="0" class="body">
        <tr>
            <td>&nbsp;</td>
            <td class="container">
                <div class="content">
                    <!--开始展示信息-->
                    <!--如果存在firing 的告警项-->
                    {{ if gt (len .Alerts.Firing) 0 }}
                    <div class="header">
                        <table border="0" cellpadding="0" cellspacing="0">
                            <tr>
                                <td class="content-block alert alert--bad">
                                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTMyIDc5LjE1OTI4NCwgMjAxNi8wNC8xOS0xMzoxMzo0MCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUuNSAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OTk4RTEyNUUyOEJFMTFFNzk5NzVDQUJBOTg4MTIzOEEiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OTk4RTEyNUYyOEJFMTFFNzk5NzVDQUJBOTg4MTIzOEEiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5OThFMTI1QzI4QkUxMUU3OTk3NUNBQkE5ODgxMjM4QSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5OThFMTI1RDI4QkUxMUU3OTk3NUNBQkE5ODgxMjM4QSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pmj/NgsAAADvSURBVHjaYvz//z8DNQETA5UB1Q1kAWJhIL4ExFJA/AWISQ0DRiDmAeJnQGzIAAxDUSAWAOLr/8kH14CYH4jFQAZ+AmIXUOQAcS8ZhvVA9boC8WcGJIliqEQgCYYFQvWUwARAnA9ICtZBxQSB+DYeg25D1YDUrkcS/wDzMjK4CcTCUMWrsRi2CioHUnMLTe4TNgNhwA+qMRtJLAsq5o9DD14DQaAFaoAnFDNAxf6TayAI7IcaxABl4wOfGMGmMjDwEki896EJWIGAus8sROYGRVLyMiMVszIj438ql18gL68EYk8qufQA48grYAECDADC/XEs27+V6gAAAABJRU5ErkJggg=="
                                         width="20" height="20" alt="email"/><span class="text">告警通知</span>
                                </td>
                            </tr>
                        </table>
                    </div>
                    {{ end }}
                    <!--逐一成列告警项(包含一项问候)-->
                    <table class="main">
                        <tr>
                            <td class="wrapper">
                                <table border="0" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td>
                                            {{ range $i, $alert := .Alerts.Firing }}
                                            {{ if ne $i 0 }}
                                            <table class="alert-hr" border="0" cellpadding="0" cellspacing="0">
                                                <tbody>
                                                <tr>
                                                    <td class="alert-hr-top">&nbsp</td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-hr-line">
                                                        <p>&nbsp;</p>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-hr-bottom">&nbsp</td>
                                                </tr>
                                                </tbody>
                                            </table>
                                            {{ end }}
                                            <table class="alert-item" border="0" cellpadding="0" cellspacing="0">
                                                <tbody>
                                                <tr>
                                                    <td align="left">
                                                        <table class="alert-item-row" border="0" cellpadding="0"
                                                               cellspacing="0">
                                                            <tbody>
                                                            <tr>
                                                                <td class="alert-item-title alert-item-title--bad">告警项：</td>
                                                                <td class="alert-item-context">
                                                                    {{ $alert.Labels.alertingModelAliasName }}
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td align="left">
                                                        <table class="alert-item-row" border="0" cellpadding="0"
                                                               cellspacing="0">
                                                            <tbody>
                                                            <tr>
                                                                <td class="alert-item-title">告警描述：</td>
                                                                <td class="alert-item-context">
                                                                    {{ $alert.Annotations.description }}
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td align="left">
                                                        <table class="alert-item-row" border="0" cellpadding="0"
                                                               cellspacing="0">
                                                            <tbody>
                                                            <tr>
                                                                <td class="alert-item-title">迁移任务：</td>
                                                                <td class="alert-item-context">
                                                                    {{ $alert.Labels.alertingTargetName}}
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td align="left">
                                                        <table class="alert-item-row" border="0" cellpadding="0"
                                                               cellspacing="0">
                                                            <tbody>
                                                            <tr>
                                                                <td class="alert-item-title">源数据库：</td>
                                                                <td class="alert-item-context">
                                                                    {{ $alert.Labels.source_db }}
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td align="left">
                                                        <table class="alert-item-row" border="0" cellpadding="0"
                                                               cellspacing="0">
                                                            <tbody>
                                                            <tr>
                                                                <td class="alert-item-title">目标数据库：</td>
                                                                <td class="alert-item-context">
                                                                    {{ $alert.Labels.target_db }}
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td align="left">
                                                        <table class="alert-item-row" border="0" cellpadding="0"
                                                               cellspacing="0">
                                                            <tbody>
                                                            <tr>
                                                                <td class="alert-item-title">告警时间：</td>
                                                                <td class="alert-item-context">{{ $alert.StartsAt.Local.Format "2006-01-02 15:04:05" }}</td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td align="left">
                                                        <table class="alert-item-row" border="0" cellpadding="0"
                                                               cellspacing="0">
                                                            <tbody>
                                                            <tr>
                                                                <td class="alert-item-title">告警级别：</td>
                                                                <td class="alert-item-context">
                                                                    {{ if eq $alert.Labels.severity "warn" }}
                                                                    <span class="level level--warnning">警告</span>
                                                                    {{ else }}
                                                                    <span class="level level--critical">严重</span>
                                                                    {{ end }}
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td align="left">
                                                        <table class="alert-item-row" border="0" cellpadding="0"
                                                               cellspacing="0">
                                                            <tbody>
                                                            <tr>
                                                                <td class="alert-item-title">告警信息：</td>
                                                                <td class="alert-item-context">
                                                                    {{ $alert.Annotations.message }}
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                </tbody>
                                            </table>
                                            {{ end }}
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                    {{ if gt (len .Alerts.Resolved) 0 }}
    
    
                    <!--告警项成列结束-->
                    <!--如果存在resolved 的告警项-->
                    <div class="header">
                        <table border="0" cellpadding="0" cellspacing="0">
                            <tr>
                                <td class="content-block alert alert--resolved">
                                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTMyIDc5LjE1OTI4NCwgMjAxNi8wNC8xOS0xMzoxMzo0MCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUuNSAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OTk4RTEyNUUyOEJFMTFFNzk5NzVDQUJBOTg4MTIzOEEiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OTk4RTEyNUYyOEJFMTFFNzk5NzVDQUJBOTg4MTIzOEEiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5OThFMTI1QzI4QkUxMUU3OTk3NUNBQkE5ODgxMjM4QSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5OThFMTI1RDI4QkUxMUU3OTk3NUNBQkE5ODgxMjM4QSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pmj/NgsAAADvSURBVHjaYvz//z8DNQETA5UB1Q1kAWJhIL4ExFJA/AWISQ0DRiDmAeJnQGzIAAxDUSAWAOLr/8kH14CYH4jFQAZ+AmIXUOQAcS8ZhvVA9boC8WcGJIliqEQgCYYFQvWUwARAnA9ICtZBxQSB+DYeg25D1YDUrkcS/wDzMjK4CcTCUMWrsRi2CioHUnMLTe4TNgNhwA+qMRtJLAsq5o9DD14DQaAFaoAnFDNAxf6TayAI7IcaxABl4wOfGMGmMjDwEki896EJWIGAus8sROYGRVLyMiMVszIj438ql18gL68EYk8qufQA48grYAECDADC/XEs27+V6gAAAABJRU5ErkJggg=="
                                         width="20" height="20" alt="email"/><span class="text">已解决告警</span>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <!--逐一成列告警项-->
                    <table class="main">
                        <tr>
                            <td class="wrapper">
                                <table border="0" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td>
    
                                            {{ range $i, $alert := .Alerts.Resolved }}
                                            {{ if ne $i 0}}
                                            <table class="alert-hr" border="0" cellpadding="0" cellspacing="0">
                                                <tbody>
                                                <tr>
                                                    <td class="alert-hr-top">&nbsp</td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-hr-line">
                                                        <p>&nbsp;</p>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-hr-bottom">&nbsp</td>
                                                </tr>
                                                </tbody>
                                            </table>
                                            {{ end }}
                                            <table class="alert-item" border="0" cellpadding="0" cellspacing="0">
                                                <tbody>
                                                <tr>
                                                    <td align="left">
                                                        <table class="alert-item-row" border="0" cellpadding="0"
                                                               cellspacing="0">
                                                            <tbody>
                                                            <tr>
                                                                <td class="alert-item-title alert-item-title--resolved">
                                                                    告警项：
                                                                </td>
                                                                <td class="alert-item-context">
                                                                    {{ $alert.Labels.alertingModelAliasName }}
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td align="left">
                                                        <table class="alert-item-row" border="0" cellpadding="0"
                                                               cellspacing="0">
                                                            <tbody>
                                                            <tr>
                                                                <td class="alert-item-title">告警描述：</td>
                                                                <td class="alert-item-context">
                                                                    {{ $alert.Annotations.description }}
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td align="left">
                                                        <table class="alert-item-row" border="0" cellpadding="0"
                                                               cellspacing="0">
                                                            <tbody>
                                                            <tr>
                                                                <td class="alert-item-title">迁移任务：</td>
                                                                <td class="alert-item-context">
                                                                    {{ $alert.Labels.alertingTargetName }}
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td align="left">
                                                        <table class="alert-item-row" border="0" cellpadding="0"
                                                               cellspacing="0">
                                                            <tbody>
                                                            <tr>
                                                                <td class="alert-item-title">源数据库：</td>
                                                                <td class="alert-item-context">
                                                                    {{ $alert.Labels.source_db }}
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td align="left">
                                                        <table class="alert-item-row" border="0" cellpadding="0"
                                                               cellspacing="0">
                                                            <tbody>
                                                            <tr>
                                                                <td class="alert-item-title">目标数据库：</td>
                                                                <td class="alert-item-context">
                                                                    {{ $alert.Labels.target_db }}
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td align="left">
                                                        <table class="alert-item-row" border="0" cellpadding="0"
                                                               cellspacing="0">
                                                            <tbody>
                                                            <tr>
                                                                <td class="alert-item-title">开始时间：</td>
                                                                <td class="alert-item-context">{{ $alert.StartsAt.Local.Format "2006-01-02 15:04:05" }}</td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td align="left">
                                                        <table class="alert-item-row" border="0" cellpadding="0"
                                                               cellspacing="0">
                                                            <tbody>
                                                            <tr>
                                                                <td class="alert-item-title">结束时间：</td>
                                                                <td class="alert-item-context">{{ $alert.EndsAt.Local.Format "2006-01-02 15:04:05" }}</td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td align="left">
                                                        <table class="alert-item-row" border="0" cellpadding="0"
                                                               cellspacing="0">
                                                            <tbody>
                                                            <tr>
                                                                <td class="alert-item-title">告警级别：</td>
                                                                <td class="alert-item-context">
                                                                    {{ if eq $alert.Labels.severity "warn" }}
                                                                    <span class="level level--warnning">警告</span>
                                                                    {{ else }}
                                                                    <span class="level level--critical">严重</span>
                                                                    {{ end }}
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td align="left">
                                                        <table class="alert-item-row" border="0" cellpadding="0"
                                                               cellspacing="0">
                                                            <tbody>
                                                            <tr>
                                                                <td class="alert-item-title">通知信息：</td>
                                                                <td class="alert-item-context">
                                                                    在过去5m内没有持续触发该告警，因此告警被判定为已解决。
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="alert-item-space">&nbsp;</td>
                                                </tr>
                                                </tbody>
                                            </table>
                                            {{ end }}
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                    {{end}}
                    <!--告警项成列结束-->
                    <!--信息展示结束-->
                </div>
            </td>
            <td>&nbsp;</td>
        </tr>
    </table>
    
    </body>
    </html>
---
# Source: monitor/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: phoenix-conf
  namespace: dts
data:
  alerting-model.yml: |-
    # 同步状态(是否同步成功)
    - name: task-status
      aliasName: task-status
      labels:
        alertingTypeName: DBMotion
      supportedTargetTypes:
        - DBMotion
      description: 迁移同步任务状态报错时，告警
      spec:
        unitOptional: false
        rules:
          - name: 同步失败
            expr: dts_task_status
            advanced:
              last: 1
              status: false
            description: 迁移同步任务状态报错时，告警
            time:
              status: true
              groupInterval: 5
              repeatInterval: 240
            match:
              labelName: ""
              values: [ ]
              prompt: ""
              desc: ""
              status: false
              op: ""
            warn:
              errorcode: sync-state-warning
              message: dts task {{ $labels.task_id }} from {{ $labels.source_db }} to {{ $labels.target_db }} migrate failed.
              suggest: check task status.
              operator: '=='
              value: 3
              status: true
            critical:
              errorcode: sync-state-critical
              message: dts task {{ $labels.task_id }} from {{ $labels.source_db }} to {{ $labels.target_db }} migrate failed.
              suggest: check task status.
              operator: '=='
              value: 3
              status: true
            severity:
              value: critical
              status: true
            unit:
              desc: ""
              value: ""
    
    # 复制延迟
    - name: binlog-delay
      aliasName: binlog-delay
      labels:
        alertingTypeName: DBMotion
      supportedTargetTypes:
        - DBMotion
      description: 复制延迟超过warning阈值时，提醒有复制延迟；超过error阈值时，严重警告。单位：秒
      spec:
        unitOptional: false
        rules:
          - name: 复制延迟
            expr: dts_binlog_delay{event_type="write"}
            advanced:
              last: 1
              status: false
            description: 复制延迟超过warning阈值时，提醒有复制延迟；超过error阈值时，严重警告。单位：秒
            time:
              status: true
              groupInterval: 5
              repeatInterval: 240
            match:
              labelName: ""
              values: [ ]
              prompt: ""
              desc: ""
              status: false
              op: ""
            warn:
              errorcode: binlog-delay-warning
              message: dts task {{ $labels.task_id }} binlog delay {{ $value }} is above warning threshold.
              suggest: check binlog delay
              operator: '>='
              value: 60
              status: true
            critical:
              errorcode: binlog-delay-critical
              message: dts task {{ $labels.task_id }} binlog delay {{ $value }} is above critical threshold.
              suggest: check binlog delay
              operator: '>='
              value: 600
              status: true
            severity:
              value: ""
              status: false
            unit:
              desc: "second"
              value: second
  alerting-type.yml: |-
    - name: DBMotion
      aliasName: DBMotion
      supportedTargetTypes:
        - DBMotion
  alerting-target-type.yml: |-
    # DBmotion
    - name: DBMotion
      aliasName: DBMotion
  alerting-templates.yml: |-
    - name: DBMotion
      type: DBMotion
      groupIntervalMinute: 5
      repeatIntervalMinute: 240
      metrics:
        - name: task-status
        - name: binlog-delay
---
# Source: monitor/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: monitor-conf
  namespace: dts
data:
  prometheus.yml: |-
    # monitor 初始化配置
    # 全局配置， 通常可以被job单独的配置覆盖
    global:
      # target 定时任务周期
      scrape_interval: 1m
      # 拉取指标超时
      scrape_timeout: 50s
      # 执行 rules 规则的时间
      evaluation_interval: 1m
      external_labels:
        cluster: monitor-ha
    
    # 规则文件列表
    rule_files:
      - /etc/monitor/rules.yml
    
    # 告警组件
    alerting:
      alert_relabel_configs:
        - source_labels: [ tid, exporter, ip ]
          separator: ;
          regex: (.*);(.*);(.*)
          target_label: routing_key
          replacement: ${1}__${2}__${3}
          action: replace
      # 告警配置文件
      alertmanagers:
        - api_version: v1
          static_configs:
            - targets: [ "alertmanager:9093" ]
          timeout: 10s
          path_prefix: /
    
    # 数据抓取配置
    scrape_configs:
      - job_name: dts-exporter
        scrape_interval: 15s
        scrape_timeout: 10s
        metrics_path: /api/motion/v2/metrics
        scheme: http
        static_configs:
          - targets: [
            'dts-api-server.dts:3000'
          ]
  alertmanager.yml: |-
    global:
      resolve_timeout: 5m
    
    route:
      group_by: ['alertname']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      receiver: 'web.hook'
    receivers:
    - name: 'web.hook'
      webhook_configs:
      - url: 'http://127.0.0.1:5001/'
    inhibit_rules:
    - source_match:
        severity: 'critical'
      target_match:
        severity: 'warning'
      equal: ['alertname', 'dev', 'instance']
  inhibit.yml: |-    # eg.同一个对象的同一告警项warn和critical都发生时抑制warn
    - source_match:
        severity: critical
      target_match:
        severity: warn
      equal:
      - _alertingTargetUuid
      - _alertingRuleUuid
---
# Source: monitor/templates/serviceaccount.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: monitor-dts
rules:
  - apiGroups: [ "apps" ]
    resources:
      - statefulsets
    verbs:
      - get
      - list
      - watch
      - create
      - update
  - apiGroups: [""]
    resources:
      - nodes
      - nodes/metrics
      - nodes/proxy
      - services
      - endpoints
      - pods
      - events
      - configmaps
      - secrets
      - namespaces
    verbs: ["get", "list", "watch", "create", "update"]
  - nonResourceURLs: ["/metrics"]
    verbs: ["get"]
---
# Source: monitor/templates/serviceaccount.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: monitor-dts
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: monitor-dts
subjects:
  - kind: ServiceAccount
    name: monitor
    namespace: dts
---
# Source: monitor/templates/service.yaml
kind: Service
apiVersion: v1
metadata:
  name: monitor-headless
  namespace: dts
  labels:
    app.kubernetes.io/name: monitor
spec:
  type: ClusterIP
  clusterIP: None
  selector:
    app.kubernetes.io/name: monitor
  ports:
    - name: web
      protocol: TCP
      port: 9090
      targetPort: web
    - name: grpc
      port: 10901
      targetPort: grpc
---
# Source: monitor/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: monitor
  labels:
    name: monitor
    kubernetes.io/cluster-service: 'true'
spec:
  ports:
    - name: monitor
      port: 9090
      protocol: TCP
      targetPort: 9090
  selector:
    app.kubernetes.io/name: monitor
  sessionAffinity: None
  type: NodePort
---
# Source: monitor/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: phoenix
  labels:
    name: phoenix
    kubernetes.io/cluster-service: 'true'
spec:
  ports:
    - name: phoenix
      nodePort: 32003
      port: 9091
      protocol: TCP
      targetPort: 9091
  selector:
    app.kubernetes.io/name: monitor
  sessionAffinity: None
  type: NodePort
---
# Source: monitor/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    name: alertmanager
    kubernetes.io/cluster-service: 'true'
  name: alertmanager
spec:
  ports:
    - name: alertmanager
      nodePort: 32006
      port: 9093
      protocol: TCP
      targetPort: 9093
  selector:
    app.kubernetes.io/name: monitor
  sessionAffinity: None
  type: NodePort
---
# Source: monitor/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: monitor
  namespace: dts
  labels:
    app.kubernetes.io/name: monitor
spec:
  serviceName: monitor-headless
  podManagementPolicy: Parallel
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: monitor
  template:
    metadata:
      name: monitor
      labels:
        app.kubernetes.io/name: monitor
        qfusion/useIstio: "true"
    spec:
      serviceAccountName: monitor
      securityContext:
        runAsUser: 0
        fsGroup: 0
      terminationGracePeriodSeconds: 30
      initContainers:
        - name: dts-monitor-conf
          image: k8smaster.qfusion.irds/irds/alpine:3.18.2
          command:
            - sh
            - -c
            - |
              cd /dts-monitor
              cp * /dts-conf/
          volumeMounts:
            - name: monitor-conf
              mountPath: /dts-monitor
            - name: shared-conf
              mountPath: /dts-conf
      containers:
        - name: phoenix
          image: k8smaster.qfusion.irds/irds/phoenix:1.4.7-dbmotion-hcs-oem
          imagePullPolicy: Always
          args:
            - "--database-address=qfusion-cmdb0.qfusion"
            - "--database-port=3306"
            - "--database-username=$(DATABASE_USERNAME)"
            - "--database-password=$(DATABASE_PASSWORD)"
            - "--database-database=dts_phoenix"
            - "--data-dir=/dts-conf"
            - "--rule-config=/rules.yml"
            - "--prom-url=http://prometheus:9090"
            - "--alert-url=http://alertmanager:9093"
            - "--tmpl-dir=/etc/alert/tmpl"
            - "--alerting-target-type-file-path=/etc/phoenix/conf/alerting-target-type.yml"
            - "--alerting-type-file-path=/etc/phoenix/conf/alerting-type.yml"
            - "--alerting-model-file-paths=/etc/phoenix/conf/alerting-model.yml"
            - "--default-templates-file-path=/etc/phoenix/conf/alerting-templates.yml"
            - "--notify-base-url=http://phoenix:9091"
            - "--http-receivers-discovery-endpoint=http://webserver-cluster.qfusion/api/v1/phoenix/alerting_receivers"
            - "--http-targets-discovery-endpoints=http://dts-api-server.dts:3000/api/motion/v2/alert/phoenix/targets"
            - "--alert-hook=http://dts-api-server.dts:3000/api/motion/v2/alert/notice"
            - "--http-discovery-interval=60"
            - "--enable-multi-tenant=false"
            - "--tailor-port=15100"
          env:
            - name: DATABASE_USERNAME
              valueFrom:
                secretKeyRef:
                  key: username
                  name: cmdb0-root-suffix
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: cmdb0-root-suffix
          ports:
            - containerPort: 9091
              protocol: TCP
              name: phoenix
          volumeMounts:
            - name: phoenix-conf
              mountPath: /etc/phoenix/conf
            - name: tmpl-volume
              mountPath: /etc/alert/tmpl
            - name: monitor-conf
              mountPath: /etc/phoenix/monitor
            - name: dts-data
              mountPath: /monitor/data
            - name: shared-conf
              mountPath: /dts-conf
            - name: timezone
              mountPath: /etc/timezone
            - name: localtime
              mountPath: /etc/localtime
        - name: prometheus
          image: k8smaster.qfusion.irds/irds/prometheus:v2.47.0
          imagePullPolicy: IfNotPresent
          args:
            - --config.file=/etc/prometheus/prometheus.yml
            - --web.enable-lifecycle
            - --storage.tsdb.retention=180d
            - --storage.tsdb.path=/prometheus/data
            - --storage.tsdb.retention.time=10d
            - --web.route-prefix=/
            - --storage.tsdb.no-lockfile
            - --storage.tsdb.min-block-duration=2h
            - --storage.tsdb.max-block-duration=2h
            - --log.level=debug
          ports:
            - name: web
              containerPort: 9090
              protocol: TCP
          livenessProbe:
            failureThreshold: 6
            httpGet:
              path: /-/healthy
              port: web
              scheme: HTTP
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 3
          readinessProbe:
            failureThreshold: 120
            httpGet:
              path: /-/ready
              port: web
              scheme: HTTP
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 3
          volumeMounts:
            - name: monitor-conf
              mountPath: /etc/prometheus
            - name: dts-data
              mountPath: /prometheus/data
            - name: shared-conf
              mountPath: /dts-conf
            - name: timezone
              mountPath: /etc/timezone
            - name: localtime
              mountPath: /etc/localtime
        - name: alertmanager
          image: k8smaster.qfusion.irds/irds/alertmanager:v0.26.0
          imagePullPolicy: IfNotPresent
          args:
            - --storage.path=/alertmanager/data
            - --cluster.advertise-address=0.0.0.0:9093
            - --config.file=/etc/alertmanager/alertmanager.yml
          ports:
            - containerPort: 9093
              protocol: TCP
              name: alertmanager
          volumeMounts:
            - name: alertmanager-tmpl
              mountPath: /etc/alert/tmpl
            - name: monitor-conf
              mountPath: /etc/alertmanager
            - name: dts-data
              mountPath: /alertmanager/data
            - name: shared-conf
              mountPath: /dts-conf
            - name: timezone
              mountPath: /etc/timezone
            - name: localtime
              mountPath: /etc/localtime
      volumes:
        - name: phoenix-conf
          configMap:
            name: phoenix-conf
        - name: monitor-conf
          configMap:
            name: monitor-conf
        - name: alertmanager-tmpl
          configMap:
            name: alertmanager-tmpl
        - name: shared-conf
          emptyDir: { }
        - name: tmpl-volume
          emptyDir: { }
        - name: timezone
          hostPath:
            path: /etc/timezone
        - name: localtime
          hostPath:
            path: /etc/localtime
      affinity: 
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                app.kubernetes.io/name: phoenix
            topologyKey: kubernetes.io/hostname
      
      nodeSelector: 
        qfusion/master: "true"
      tolerations: 
        - effect: NoSchedule
          key: node-role.kubernetes.io/master
          operator: Exists
